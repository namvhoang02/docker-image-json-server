version: 2.1

# Define the jobs we want to run for this project
jobs:
  prepare:
    docker:
      - image: circleci/node:12.10.0
    steps:
      - checkout
      - run: echo "prepare job - skip for now"
  test:
    docker:
      - image: circleci/node:12.10.0
    steps:
      - checkout
      - run: echo "test job - skip for now"
  lint:
    docker:
      - image: circleci/node:12.10.0
    steps:
      - checkout
      - run: echo "lint job - skip for now"
  build:
    docker:
      - image: circleci/node:12.10.0
    steps:
      - checkout
      - run: echo "build job - skip for now"
  publish:
    machine: true
    steps:
      - checkout
      - run:
          name: "Login docker hub"
          command: |
            docker login -u $DOCKER_HUB_USER -p $DOCKER_HUB_TOKEN
      # Run a step to setup an environment variable
      - run:
          name: "Setup custom environment variables"
          command: |
            echo 'export CI_PROJECT_DIR="$(pwd)"' >> $BASH_ENV
            echo 'export CI_IMAGE="$DOCKER_HUB_USER/json-server"' >> $BASH_ENV
            echo 'export CI_REGISTRY_IMAGE="docker.io/${CI_IMAGE}"' >> $BASH_ENV
      - run:
          name: "Run building scripts"
          command: |
            chmod +x -R $CI_PROJECT_DIR/scripts
            while IFS= read -r line
            do
              $CI_PROJECT_DIR/scripts/custom-docker-build $line -t "$CI_REGISTRY_IMAGE:$line"
            done < "$CI_PROJECT_DIR/VERSIONS"

# Orchestrate our job run sequence
workflows:
  build_and_test:
    jobs:
      # - prepare
      # - test:
      #     requires:
      #       - prepare
      # - lint:
      #     requires:
      #       - prepare
      # - build:
      #     requires:
      #       - test
      #       - lint
      # - publish:
      #     requires:
      #       - build
      - publish
